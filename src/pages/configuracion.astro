---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
---

<Layout title="Configuraci√≥n - Sistema IoT">
  <Navigation />
  
  <main class="px-4 py-6 pb-20">
    <div class="text-center mb-6">
      <div class="text-5xl mb-3">‚öôÔ∏è</div>
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
        Configuraci√≥n del Sistema
      </h1>
      <p class="text-sm text-gray-600">
        Modifica los ajustes de tu dispositivo IoT
      </p>
    </div>

    <!-- Bot√≥n de autenticaci√≥n -->
    <div id="authWarning" class="max-w-lg mx-auto mb-6">
      <button id="authButton" class="w-full bg-orange-50 border-2 border-orange-200 rounded-xl p-4 hover:bg-orange-100 active:scale-98 transition-all">
        <div class="flex items-center justify-center space-x-3">
          <span class="text-2xl">üîí</span>
          <div>
            <p class="text-sm font-semibold text-orange-800">
              Debes iniciar sesi√≥n para modificar
            </p>
            <p class="text-xs text-orange-600">
              Toca aqu√≠ para autenticarte
            </p>
          </div>
        </div>
      </button>
    </div>

    <!-- Cards de configuraci√≥n -->
    <div class="max-w-lg mx-auto space-y-4">
      
      <!-- 1. Duraci√≥n en minutos -->
      <div class="bg-white p-5 rounded-xl shadow-md">
        <div class="flex items-center justify-between mb-3">
          <label class="flex items-center space-x-2">
            <span class="text-2xl">‚è±Ô∏è</span>
            <span class="text-sm font-semibold text-gray-700">Duraci√≥n en minutos</span>
          </label>
          <button class="editBtn hidden px-3 py-1 bg-blue-500 text-white text-xs rounded-lg font-semibold hover:bg-blue-600 active:scale-95 transition" data-config="duracion">
            Editar
          </button>
        </div>
        <div class="text-center">
          <span id="duracion-value" class="text-3xl font-bold text-gray-900">2</span>
          <span class="text-lg text-gray-600 ml-1">min</span>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">
          Tiempo que riega la bomba
        </p>
      </div>

      <!-- 2. Hora programada -->
      <div class="bg-white p-5 rounded-xl shadow-md">
        <div class="flex items-center justify-between mb-3">
          <label class="flex items-center space-x-2">
            <span class="text-2xl">üïê</span>
            <span class="text-sm font-semibold text-gray-700">Hora programada</span>
          </label>
          <button class="editBtn hidden px-3 py-1 bg-blue-500 text-white text-xs rounded-lg font-semibold hover:bg-blue-600 active:scale-95 transition" data-config="hora">
            Editar
          </button>
        </div>
        <div class="text-center">
          <span id="hora-value" class="text-3xl font-bold text-gray-900">21:06</span>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">
          Hora de riego diario autom√°tico
        </p>
      </div>

      <!-- 3. Umbral de humedad -->
      <div class="bg-white p-5 rounded-xl shadow-md">
        <div class="flex items-center justify-between mb-3">
          <label class="flex items-center space-x-2">
            <span class="text-2xl">üíß</span>
            <span class="text-sm font-semibold text-gray-700">Umbral de humedad</span>
          </label>
          <button class="editBtn hidden px-3 py-1 bg-blue-500 text-white text-xs rounded-lg font-semibold hover:bg-blue-600 active:scale-95 transition" data-config="humedad">
            Editar
          </button>
        </div>
        <div class="text-center">
          <span id="humedad-value" class="text-3xl font-bold text-gray-900">65</span>
          <span class="text-lg text-gray-600 ml-1">%</span>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">
          Activa bomba si supera este valor
        </p>
      </div>

      <!-- 4. Temperatura m√°xima ventilador -->
      <div class="bg-white p-5 rounded-xl shadow-md">
        <div class="flex items-center justify-between mb-3">
          <label class="flex items-center space-x-2">
            <span class="text-2xl">üå°Ô∏è</span>
            <span class="text-sm font-semibold text-gray-700">Temp. m√°x ventilador</span>
          </label>
          <button class="editBtn hidden px-3 py-1 bg-blue-500 text-white text-xs rounded-lg font-semibold hover:bg-blue-600 active:scale-95 transition" data-config="tempVent">
            Editar
          </button>
        </div>
        <div class="text-center">
          <span id="tempVent-value" class="text-3xl font-bold text-gray-900">16</span>
          <span class="text-lg text-gray-600 ml-1">¬∞C</span>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">
          Enciende ventilador si supera esta temperatura
        </p>
      </div>

      <!-- 5. Temperatura m√≠nima luz -->
      <div class="bg-white p-5 rounded-xl shadow-md">
        <div class="flex items-center justify-between mb-3">
          <label class="flex items-center space-x-2">
            <span class="text-2xl">üí°</span>
            <span class="text-sm font-semibold text-gray-700">Temp. m√≠n luz</span>
          </label>
          <button class="editBtn hidden px-3 py-1 bg-blue-500 text-white text-xs rounded-lg font-semibold hover:bg-blue-600 active:scale-95 transition" data-config="tempLuz">
            Editar
          </button>
        </div>
        <div class="text-center">
          <span id="tempLuz-value" class="text-3xl font-bold text-gray-900">26</span>
          <span class="text-lg text-gray-600 ml-1">¬∞C</span>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">
          Enciende luces si baja de esta temperatura
        </p>
      </div>

    </div>

    <!-- Info adicional -->
    <div class="max-w-lg mx-auto mt-6 bg-gray-50 p-4 rounded-lg">
      <p class="text-xs text-gray-600 text-center">
        ‚ÑπÔ∏è Los cambios se sincronizar√°n autom√°ticamente con tu dispositivo IoT
      </p>
    </div>
  </main>

  <!-- Modal: Duraci√≥n en minutos -->
  <div id="modal-duracion" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-[#1a1d29] rounded-xl w-full max-w-sm p-6 relative animate-fade-in shadow-2xl">
      <button class="closeModal absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">‚è±Ô∏è</div>
        <h3 class="text-xl font-bold text-white">Duraci√≥n de riego</h3>
        <p class="text-sm text-gray-400 mt-1">Tiempo en minutos</p>
      </div>

      <div class="mb-6">
        <input 
          type="number" 
          id="input-duracion"
          min="1"
          max="60"
          class="w-full px-4 py-3 bg-[#0f1117] border-2 border-gray-700 rounded-lg text-white text-center text-2xl font-bold focus:border-blue-500 focus:outline-none"
          value="2"
        />
        <p class="text-xs text-gray-500 mt-2 text-center">Rango: 1-60 minutos</p>
      </div>

      <button class="saveBtn w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 active:scale-95 transition" data-config="duracion">
        üíæ Guardar cambios
      </button>
    </div>
  </div>

  <!-- Modal: Hora programada -->
  <div id="modal-hora" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-[#1a1d29] rounded-xl w-full max-w-sm p-6 relative animate-fade-in shadow-2xl">
      <button class="closeModal absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">üïê</div>
        <h3 class="text-xl font-bold text-white">Hora de riego</h3>
        <p class="text-sm text-gray-400 mt-1">Formato 24 horas</p>
      </div>

      <div class="mb-6">
        <input 
          type="time" 
          id="input-hora"
          class="w-full px-4 py-3 bg-[#0f1117] border-2 border-gray-700 rounded-lg text-white text-center text-2xl font-bold focus:border-blue-500 focus:outline-none"
          value="21:06"
        />
        <p class="text-xs text-gray-500 mt-2 text-center">Hora diaria de activaci√≥n autom√°tica</p>
      </div>

      <button class="saveBtn w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 active:scale-95 transition" data-config="hora">
        üíæ Guardar cambios
      </button>
    </div>
  </div>

  <!-- Modal: Umbral de humedad -->
  <div id="modal-humedad" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-[#1a1d29] rounded-xl w-full max-w-sm p-6 relative animate-fade-in shadow-2xl">
      <button class="closeModal absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">üíß</div>
        <h3 class="text-xl font-bold text-white">Umbral de humedad</h3>
        <p class="text-sm text-gray-400 mt-1">Porcentaje de activaci√≥n</p>
      </div>

      <div class="mb-6">
        <input 
          type="number" 
          id="input-humedad"
          min="0"
          max="100"
          class="w-full px-4 py-3 bg-[#0f1117] border-2 border-gray-700 rounded-lg text-white text-center text-2xl font-bold focus:border-blue-500 focus:outline-none"
          value="65"
        />
        <p class="text-xs text-gray-500 mt-2 text-center">Rango: 0-100%</p>
      </div>

      <button class="saveBtn w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 active:scale-95 transition" data-config="humedad">
        üíæ Guardar cambios
      </button>
    </div>
  </div>

  <!-- Modal: Temperatura m√°xima ventilador -->
  <div id="modal-tempVent" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-[#1a1d29] rounded-xl w-full max-w-sm p-6 relative animate-fade-in shadow-2xl">
      <button class="closeModal absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">üå°Ô∏è</div>
        <h3 class="text-xl font-bold text-white">Temp. m√°x ventilador</h3>
        <p class="text-sm text-gray-400 mt-1">Temperatura de activaci√≥n</p>
      </div>

      <div class="mb-6">
        <input 
          type="number" 
          id="input-tempVent"
          min="-10"
          max="50"
          class="w-full px-4 py-3 bg-[#0f1117] border-2 border-gray-700 rounded-lg text-white text-center text-2xl font-bold focus:border-blue-500 focus:outline-none"
          value="16"
        />
        <p class="text-xs text-gray-500 mt-2 text-center">Rango: -10 a 50¬∞C</p>
      </div>

      <button class="saveBtn w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 active:scale-95 transition" data-config="tempVent">
        üíæ Guardar cambios
      </button>
    </div>
  </div>

  <!-- Modal: Temperatura m√≠nima luz -->
  <div id="modal-tempLuz" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-[#1a1d29] rounded-xl w-full max-w-sm p-6 relative animate-fade-in shadow-2xl">
      <button class="closeModal absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">üí°</div>
        <h3 class="text-xl font-bold text-white">Temp. m√≠n luz</h3>
        <p class="text-sm text-gray-400 mt-1">Temperatura de activaci√≥n</p>
      </div>

      <div class="mb-6">
        <input 
          type="number" 
          id="input-tempLuz"
          min="-10"
          max="50"
          class="w-full px-4 py-3 bg-[#0f1117] border-2 border-gray-700 rounded-lg text-white text-center text-2xl font-bold focus:border-blue-500 focus:outline-none"
          value="26"
        />
        <p class="text-xs text-gray-500 mt-2 text-center">Rango: -10 a 50¬∞C</p>
      </div>

      <button class="saveBtn w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 active:scale-95 transition" data-config="tempLuz">
        üíæ Guardar cambios
      </button>
    </div>
  </div>
</Layout>

<script>
//  IMPORTAR FIREBASE Y AUTH
import { leerConfiguracion } from '../app/read.js';
import { actualizarCampoConfiguracion } from '../app/write.js';

//  TIPOS DE DATOS

type ConfiguracionData = {
  duracion_minutos: number;
  hora_programada: string;
  humedad_umbral_activacion: number;
  max_temp_ventilador: number;
  min_temp_luz: number;
};

type AuthState = {
  isAuthenticated: boolean;
  user: {
    uid: string;
    email: string;
    displayName: string;
    photoURL?: string;
  } | null;
};

//  ESTADO DE AUTENTICACI√ìN
let currentAuthState: AuthState = {
  isAuthenticated: false,
  user: null
};

//  LEER DATOS EN TIEMPO REAL

// Leer configuraci√≥n desde Firebase
leerConfiguracion((datos: ConfiguracionData | null) => {
  if (datos) {
    console.log('‚öôÔ∏è Datos recibidos de configuraci√≥n:', datos);
    updateConfigUI(datos);
  }
});

//  FUNCI√ìN PARA ACTUALIZAR UI

function updateConfigUI(config: ConfiguracionData): void {
  // Actualizar valores en las cards
  const duracionValue = document.getElementById('duracion-value');
  const horaValue = document.getElementById('hora-value');
  const humedadValue = document.getElementById('humedad-value');
  const tempVentValue = document.getElementById('tempVent-value');
  const tempLuzValue = document.getElementById('tempLuz-value');

  if (duracionValue) duracionValue.textContent = `${config.duracion_minutos}`;
  if (horaValue) horaValue.textContent = config.hora_programada;
  if (humedadValue) humedadValue.textContent = `${config.humedad_umbral_activacion}`;
  if (tempVentValue) tempVentValue.textContent = `${config.max_temp_ventilador}`;
  if (tempLuzValue) tempLuzValue.textContent = `${config.min_temp_luz}`;

  // Tambi√©n actualizar los inputs de los modales
  const inputDuracion = document.getElementById('input-duracion') as HTMLInputElement;
  const inputHora = document.getElementById('input-hora') as HTMLInputElement;
  const inputHumedad = document.getElementById('input-humedad') as HTMLInputElement;
  const inputTempVent = document.getElementById('input-tempVent') as HTMLInputElement;
  const inputTempLuz = document.getElementById('input-tempLuz') as HTMLInputElement;

  if (inputDuracion) inputDuracion.value = `${config.duracion_minutos}`;
  if (inputHora) inputHora.value = config.hora_programada;
  if (inputHumedad) inputHumedad.value = `${config.humedad_umbral_activacion}`;
  if (inputTempVent) inputTempVent.value = `${config.max_temp_ventilador}`;
  if (inputTempLuz) inputTempLuz.value = `${config.min_temp_luz}`;
}


//  ESCUCHAR CAMBIOS DE AUTENTICACI√ìN

// Escucha el evento que dispara Navigation.astro cuando cambia el usuario
window.addEventListener('userAuthChanged', ((event: CustomEvent<AuthState>) => {
  currentAuthState = event.detail;
  console.log('üîÑ Estado de auth actualizado en configuraci√≥n:', currentAuthState);
  updateAuthUI();
}) as EventListener);


// üé® ACTUALIZAR UI SEG√öN AUTH

function updateAuthUI(): void {
  const authButton = document.getElementById('authButton');
  const editButtons = document.querySelectorAll('.editBtn');

  if (currentAuthState.isAuthenticated && currentAuthState.user) {
    // Usuario LOGUEADO
    const user = currentAuthState.user;
    
    // Cambiar bot√≥n a mostrar usuario
    if (authButton) {
      authButton.innerHTML = `
        <div class="flex items-center justify-center space-x-3">
          <span class="text-2xl">üë§</span>
          <div>
            <p class="text-sm font-semibold text-green-800">
              ${user.displayName}
            </p>
            <p class="text-xs text-green-600">
              Sesi√≥n activa
            </p>
          </div>
        </div>
      `;
      authButton.classList.remove('bg-orange-50', 'border-orange-200', 'hover:bg-orange-100');
      authButton.classList.add('bg-green-50', 'border-green-200', 'hover:bg-green-100');
    }

    // Mostrar TODOS los botones de editar
    editButtons.forEach(btn => btn.classList.remove('hidden'));
    
  } else {
    // Usuario NO LOGUEADO
    
    // Cambiar bot√≥n a estado "no autenticado"
    if (authButton) {
      authButton.innerHTML = `
        <div class="flex items-center justify-center space-x-3">
          <span class="text-2xl">üîí</span>
          <div>
            <p class="text-sm font-semibold text-orange-800">
              Debes iniciar sesi√≥n para modificar
            </p>
            <p class="text-xs text-orange-600">
              Toca aqu√≠ para autenticarte
            </p>
          </div>
        </div>
      `;
      authButton.classList.remove('bg-green-50', 'border-green-200', 'hover:bg-green-100');
      authButton.classList.add('bg-orange-50', 'border-orange-200', 'hover:bg-orange-100');
    }

    // Ocultar botones de editar
    editButtons.forEach(btn => btn.classList.add('hidden'));
  }
}

//  EVENTOS DE UI (MODALES)

// ABRIR MODAL DE LOGIN
const authButton = document.getElementById('authButton');
authButton?.addEventListener('click', () => {
  if (!currentAuthState.isAuthenticated) {
    // Si NO est√° logueado, abrir modal de login
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
      loginModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  }
  // Si YA est√° logueado, no hacer nada (solo muestra el estado)
});

const editButtons = document.querySelectorAll('.editBtn');
editButtons.forEach(btn => {
  btn.addEventListener('click', (e) => {
    const config = (e.target as HTMLElement).dataset.config;
    const modal = document.getElementById(`modal-${config}`);
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  });
});

// CERRAR MODALES
const closeButtons = document.querySelectorAll('.closeModal');
closeButtons.forEach(btn => {
  btn.addEventListener('click', (e) => {
    const modal = (e.target as HTMLElement).closest('[id^="modal-"]');
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
  });
});

//  GUARDAR CAMBIOS EN FIREBASE

const saveButtons = document.querySelectorAll('.saveBtn');
saveButtons.forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const configType = (e.target as HTMLElement).dataset.config;
    const input = document.getElementById(`input-${configType}`) as HTMLInputElement;
    const valueDisplay = document.getElementById(`${configType}-value`);

    if (!input || !valueDisplay) return;

    const newValue = input.value;

    // Mapear el tipo de config al nombre del campo en Firebase
    const fieldMap: Record<string, string> = {
      'duracion': 'duracion_minutos',
      'hora': 'hora_programada',
      'humedad': 'humedad_umbral_activacion',
      'tempVent': 'max_temp_ventilador',
      'tempLuz': 'min_temp_luz'
    };

    const fieldName = fieldMap[configType || ''];
    
    if (!fieldName) {
      console.error('‚ùå Tipo de configuraci√≥n no v√°lido:', configType);
      mostrarAlerta('Error: configuraci√≥n no v√°lida', 'error');
      return;
    }

    // Convertir a n√∫mero si no es la hora
    const valorFinal = fieldName === 'hora_programada' ? newValue : Number(newValue);

    console.log(`üíæ Guardando ${fieldName} = ${valorFinal}`);

    // Llamar a write.js para guardar en Firebase
    const resultado = await actualizarCampoConfiguracion(fieldName, valorFinal);

    if (resultado.success) {
      console.log('‚úÖ Guardado exitoso');
      
      // Actualizar la UI
      valueDisplay.textContent = newValue;
      
      // Mostrar alerta de √©xito
      mostrarAlerta('‚úÖ Configuraci√≥n guardada correctamente', 'success');
      
      // Cerrar modal
      const modal = document.getElementById(`modal-${configType}`);
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
      }
    } else {
      console.error('‚ùå Error al guardar:', resultado.error);
      
      // Mostrar alerta de error
      mostrarAlerta(resultado.error || 'Error al guardar', 'error');
    }
  });
});

// üì¢ SISTEMA DE ALERTAS
function mostrarAlerta(mensaje: string, tipo: 'success' | 'error' | 'warning' | 'info' = 'info'): void {
  // Crear elemento de alerta
  const alerta = document.createElement('div');
  alerta.className = 'fixed top-4 right-4 z-[200] px-6 py-4 rounded-lg shadow-2xl animate-slide-in max-w-sm';
  
  // Colores seg√∫n tipo
  switch (tipo) {
    case 'success':
      alerta.classList.add('bg-green-600', 'text-white');
      break;
    case 'error':
      alerta.classList.add('bg-red-600', 'text-white');
      break;
    case 'warning':
      alerta.classList.add('bg-orange-600', 'text-white');
      break;
    default:
      alerta.classList.add('bg-blue-600', 'text-white');
  }
  
  alerta.innerHTML = `
    <div class="flex items-center space-x-3">
      <span class="text-lg">${tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
      <p class="text-sm font-medium">${mensaje}</p>
    </div>
  `;
  
  document.body.appendChild(alerta);
  
  // Auto-remover despu√©s de 4 segundos
  setTimeout(() => {
    alerta.classList.add('animate-slide-out');
    setTimeout(() => alerta.remove(), 300);
  }, 4000);
}

// Estilos para animaciones de alerta
const style = document.createElement('style');
style.textContent = `
  @keyframes slide-in {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slide-out {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
  
  .animate-slide-in {
    animation: slide-in 0.3s ease-out;
  }
  
  .animate-slide-out {
    animation: slide-out 0.3s ease-in;
  }
`;
document.head.appendChild(style);

//  INICIALIZAR UI
updateAuthUI();
</script>
<style>
  .animate-fade-in {
    animation: fadeIn 0.2s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  input[type="time"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
  }
</style>