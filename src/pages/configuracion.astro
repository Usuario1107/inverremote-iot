---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
---

<Layout title="ConfiguraciÃ³n - Sistema IoT">
  <Navigation />
  
  <main class="px-4 py-6 pb-20">
    <div class="text-center mb-6">
      <div class="text-5xl mb-3">âš™ï¸</div>
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
        ConfiguraciÃ³n del Sistema
      </h1>
      <p class="text-sm text-gray-600">
        Modifica los ajustes de tu dispositivo IoT
      </p>
    </div>

    <!-- BotÃ³n de autenticaciÃ³n -->
    <div id="authWarning" class="max-w-lg mx-auto mb-6">
      <button id="authButton" class="w-full bg-orange-50 border-2 border-orange-200 rounded-xl p-4 hover:bg-orange-100 active:scale-98 transition-all">
        <div class="flex items-center justify-center space-x-3">
          <span class="text-2xl">ğŸ”’</span>
          <div>
            <p class="text-sm font-semibold text-orange-800">
              Debes iniciar sesiÃ³n para modificar
            </p>
            <p class="text-xs text-orange-600">
              Toca aquÃ­ para autenticarte
            </p>
          </div>
        </div>
      </button>
    </div>

    <!-- Cards de configuraciÃ³n -->
    <div class="max-w-lg mx-auto space-y-4">
      
      <!-- 1. DuraciÃ³n en minutos -->
      <div class="bg-white p-5 rounded-xl shadow-md">
        <div class="flex items-center justify-between mb-3">
          <label class="flex items-center space-x-2">
            <span class="text-2xl">â±ï¸</span>
            <span class="text-sm font-semibold text-gray-700">DuraciÃ³n en minutos</span>
          </label>
          <button class="editBtn hidden px-3 py-1 bg-blue-500 text-white text-xs rounded-lg font-semibold hover:bg-blue-600 active:scale-95 transition" data-config="duracion">
            Editar
          </button>
        </div>
        <div class="text-center">
          <span id="duracion-value" class="text-3xl font-bold text-gray-900">2</span>
          <span class="text-lg text-gray-600 ml-1">min</span>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">
          Tiempo que riega la bomba
        </p>
      </div>

      <!-- 2. Hora programada -->
      <div class="bg-white p-5 rounded-xl shadow-md">
        <div class="flex items-center justify-between mb-3">
          <label class="flex items-center space-x-2">
            <span class="text-2xl">ğŸ•</span>
            <span class="text-sm font-semibold text-gray-700">Hora programada</span>
          </label>
          <button class="editBtn hidden px-3 py-1 bg-blue-500 text-white text-xs rounded-lg font-semibold hover:bg-blue-600 active:scale-95 transition" data-config="hora">
            Editar
          </button>
        </div>
        <div class="text-center">
          <span id="hora-value" class="text-3xl font-bold text-gray-900">21:06</span>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">
          Hora de riego diario automÃ¡tico
        </p>
      </div>

      <!-- 3. Umbral de humedad -->
      <div class="bg-white p-5 rounded-xl shadow-md">
        <div class="flex items-center justify-between mb-3">
          <label class="flex items-center space-x-2">
            <span class="text-2xl">ğŸ’§</span>
            <span class="text-sm font-semibold text-gray-700">Umbral de humedad</span>
          </label>
          <button class="editBtn hidden px-3 py-1 bg-blue-500 text-white text-xs rounded-lg font-semibold hover:bg-blue-600 active:scale-95 transition" data-config="humedad">
            Editar
          </button>
        </div>
        <div class="text-center">
          <span id="humedad-value" class="text-3xl font-bold text-gray-900">65</span>
          <span class="text-lg text-gray-600 ml-1">%</span>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">
          Activa bomba si supera este valor
        </p>
      </div>

      <!-- 4. Temperatura mÃ¡xima ventilador -->
      <div class="bg-white p-5 rounded-xl shadow-md">
        <div class="flex items-center justify-between mb-3">
          <label class="flex items-center space-x-2">
            <span class="text-2xl">ğŸŒ¡ï¸</span>
            <span class="text-sm font-semibold text-gray-700">Temp. mÃ¡x ventilador</span>
          </label>
          <button class="editBtn hidden px-3 py-1 bg-blue-500 text-white text-xs rounded-lg font-semibold hover:bg-blue-600 active:scale-95 transition" data-config="tempVent">
            Editar
          </button>
        </div>
        <div class="text-center">
          <span id="tempVent-value" class="text-3xl font-bold text-gray-900">16</span>
          <span class="text-lg text-gray-600 ml-1">Â°C</span>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">
          Enciende ventilador si supera esta temperatura
        </p>
      </div>

      <!-- 5. Temperatura mÃ­nima luz -->
      <div class="bg-white p-5 rounded-xl shadow-md">
        <div class="flex items-center justify-between mb-3">
          <label class="flex items-center space-x-2">
            <span class="text-2xl">ğŸ’¡</span>
            <span class="text-sm font-semibold text-gray-700">Temp. mÃ­n luz</span>
          </label>
          <button class="editBtn hidden px-3 py-1 bg-blue-500 text-white text-xs rounded-lg font-semibold hover:bg-blue-600 active:scale-95 transition" data-config="tempLuz">
            Editar
          </button>
        </div>
        <div class="text-center">
          <span id="tempLuz-value" class="text-3xl font-bold text-gray-900">26</span>
          <span class="text-lg text-gray-600 ml-1">Â°C</span>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">
          Enciende luces si baja de esta temperatura
        </p>
      </div>

    </div>

    <!-- Info adicional -->
    <div class="max-w-lg mx-auto mt-6 bg-gray-50 p-4 rounded-lg">
      <p class="text-xs text-gray-600 text-center">
        â„¹ï¸ Los cambios se sincronizarÃ¡n automÃ¡ticamente con tu dispositivo IoT
      </p>
    </div>
  </main>

  <!-- Modal: DuraciÃ³n en minutos -->
  <div id="modal-duracion" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-[#1a1d29] rounded-xl w-full max-w-sm p-6 relative animate-fade-in shadow-2xl">
      <button class="closeModal absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">â±ï¸</div>
        <h3 class="text-xl font-bold text-white">DuraciÃ³n de riego</h3>
        <p class="text-sm text-gray-400 mt-1">Tiempo en minutos</p>
      </div>

      <div class="mb-6">
        <input 
          type="number" 
          id="input-duracion"
          min="1"
          max="60"
          class="w-full px-4 py-3 bg-[#0f1117] border-2 border-gray-700 rounded-lg text-white text-center text-2xl font-bold focus:border-blue-500 focus:outline-none"
          value="2"
        />
        <p class="text-xs text-gray-500 mt-2 text-center">Rango: 1-60 minutos</p>
      </div>

      <button class="saveBtn w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 active:scale-95 transition" data-config="duracion">
        ğŸ’¾ Guardar cambios
      </button>
    </div>
  </div>

  <!-- Modal: Hora programada -->
  <div id="modal-hora" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-[#1a1d29] rounded-xl w-full max-w-sm p-6 relative animate-fade-in shadow-2xl">
      <button class="closeModal absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">ğŸ•</div>
        <h3 class="text-xl font-bold text-white">Hora de riego</h3>
        <p class="text-sm text-gray-400 mt-1">Formato 24 horas</p>
      </div>

      <div class="mb-6">
        <input 
          type="time" 
          id="input-hora"
          class="w-full px-4 py-3 bg-[#0f1117] border-2 border-gray-700 rounded-lg text-white text-center text-2xl font-bold focus:border-blue-500 focus:outline-none"
          value="21:06"
        />
        <p class="text-xs text-gray-500 mt-2 text-center">Hora diaria de activaciÃ³n automÃ¡tica</p>
      </div>

      <button class="saveBtn w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 active:scale-95 transition" data-config="hora">
        ğŸ’¾ Guardar cambios
      </button>
    </div>
  </div>

  <!-- Modal: Umbral de humedad -->
  <div id="modal-humedad" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-[#1a1d29] rounded-xl w-full max-w-sm p-6 relative animate-fade-in shadow-2xl">
      <button class="closeModal absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">ğŸ’§</div>
        <h3 class="text-xl font-bold text-white">Umbral de humedad</h3>
        <p class="text-sm text-gray-400 mt-1">Porcentaje de activaciÃ³n</p>
      </div>

      <div class="mb-6">
        <input 
          type="number" 
          id="input-humedad"
          min="0"
          max="100"
          class="w-full px-4 py-3 bg-[#0f1117] border-2 border-gray-700 rounded-lg text-white text-center text-2xl font-bold focus:border-blue-500 focus:outline-none"
          value="65"
        />
        <p class="text-xs text-gray-500 mt-2 text-center">Rango: 0-100%</p>
      </div>

      <button class="saveBtn w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 active:scale-95 transition" data-config="humedad">
        ğŸ’¾ Guardar cambios
      </button>
    </div>
  </div>

  <!-- Modal: Temperatura mÃ¡xima ventilador -->
  <div id="modal-tempVent" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-[#1a1d29] rounded-xl w-full max-w-sm p-6 relative animate-fade-in shadow-2xl">
      <button class="closeModal absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">ğŸŒ¡ï¸</div>
        <h3 class="text-xl font-bold text-white">Temp. mÃ¡x ventilador</h3>
        <p class="text-sm text-gray-400 mt-1">Temperatura de activaciÃ³n</p>
      </div>

      <div class="mb-6">
        <input 
          type="number" 
          id="input-tempVent"
          min="-10"
          max="50"
          class="w-full px-4 py-3 bg-[#0f1117] border-2 border-gray-700 rounded-lg text-white text-center text-2xl font-bold focus:border-blue-500 focus:outline-none"
          value="16"
        />
        <p class="text-xs text-gray-500 mt-2 text-center">Rango: -10 a 50Â°C</p>
      </div>

      <button class="saveBtn w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 active:scale-95 transition" data-config="tempVent">
        ğŸ’¾ Guardar cambios
      </button>
    </div>
  </div>

  <!-- Modal: Temperatura mÃ­nima luz -->
  <div id="modal-tempLuz" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-[#1a1d29] rounded-xl w-full max-w-sm p-6 relative animate-fade-in shadow-2xl">
      <button class="closeModal absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">ğŸ’¡</div>
        <h3 class="text-xl font-bold text-white">Temp. mÃ­n luz</h3>
        <p class="text-sm text-gray-400 mt-1">Temperatura de activaciÃ³n</p>
      </div>

      <div class="mb-6">
        <input 
          type="number" 
          id="input-tempLuz"
          min="-10"
          max="50"
          class="w-full px-4 py-3 bg-[#0f1117] border-2 border-gray-700 rounded-lg text-white text-center text-2xl font-bold focus:border-blue-500 focus:outline-none"
          value="26"
        />
        <p class="text-xs text-gray-500 mt-2 text-center">Rango: -10 a 50Â°C</p>
      </div>

      <button class="saveBtn w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 active:scale-95 transition" data-config="tempLuz">
        ğŸ’¾ Guardar cambios
      </button>
    </div>
  </div>
</Layout>

<script>
  // ğŸ”¥ DATOS SIMULADOS (despuÃ©s vendrÃ¡n de Firebase)
  const configData = {
    duracion_minutos: 2,
    hora_programada: "21:06",
    humedad_umbral_activacion: 65,
    max_temp_ventilador: 16,
    min_temp_luz: 26
  };

  // ğŸ” SIMULACIÃ“N DE AUTENTICACIÃ“N (cambiar para probar)
  const authState = {
    isAuthenticated: true, // Cambiar a true para probar modo autenticado
    user: { email: "admin" } // para probar como admin
  };

  // ğŸ¨ ACTUALIZAR UI SEGÃšN AUTH
  function updateAuthUI() {
    const authButton = document.getElementById('authButton');
    const editButtons = document.querySelectorAll('.editBtn');

    if (authState.isAuthenticated) {
      // Cambiar botÃ³n a mostrar usuario
      if (authButton) {
        authButton.innerHTML = `
          <div class="flex items-center justify-center space-x-3">
            <span class="text-2xl">ğŸ‘¤</span>
            <div>
              <p class="text-sm font-semibold text-green-800">
                ${authState.user?.email || 'Usuario'}
              </p>
              <p class="text-xs text-green-600">
                SesiÃ³n activa
              </p>
            </div>
          </div>
        `;
        authButton.classList.remove('bg-orange-50', 'border-orange-200', 'hover:bg-orange-100');
        authButton.classList.add('bg-green-50', 'border-green-200', 'hover:bg-green-100');
      }

      // Mostrar botones de editar si es admin
      if (authState.user?.email === 'admin') {
        editButtons.forEach(btn => btn.classList.remove('hidden'));
      }
    }
  }

  // ğŸ“‚ ABRIR MODAL DE LOGIN (desde Navigation.astro)
  const authButton = document.getElementById('authButton');
  authButton?.addEventListener('click', () => {
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
      loginModal.classList.remove('hidden');
    }
  });

  // ğŸ“ ABRIR MODALES DE EDICIÃ“N
  const editButtons = document.querySelectorAll('.editBtn');
  editButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const config = (e.target as HTMLElement).dataset.config;
      const modal = document.getElementById(`modal-${config}`);
      if (modal) modal.classList.remove('hidden');
    });
  });

  // âŒ CERRAR MODALES
  const closeButtons = document.querySelectorAll('.closeModal');
  closeButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const modal = (e.target as HTMLElement).closest('[id^="modal-"]');
      if (modal) modal.classList.add('hidden');
    });
  });

  // ğŸ’¾ GUARDAR CAMBIOS
  const saveButtons = document.querySelectorAll('.saveBtn');
  saveButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const config = (e.target as HTMLElement).dataset.config;
      const input = document.getElementById(`input-${config}`) as HTMLInputElement;
      const valueDisplay = document.getElementById(`${config}-value`);

      if (input && valueDisplay) {
        const newValue = input.value;
        valueDisplay.textContent = newValue;
        
        // AquÃ­ irÃ­a la lÃ³gica de guardar en Firebase
        console.log(`âœ… Guardado: ${config} = ${newValue}`);
        
        // Cerrar modal
        const modal = document.getElementById(`modal-${config}`);
        if (modal) modal.classList.add('hidden');
      }
    });
  });

  // ğŸš€ INICIALIZAR
  updateAuthUI();
  console.log('âœ… ConfiguraciÃ³n cargada - Datos simulados activos');
</script>

<style>
  .animate-fade-in {
    animation: fadeIn 0.2s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  input[type="time"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
  }
</style>