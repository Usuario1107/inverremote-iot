---
// src/pages/sensores.astro
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
---

<Layout title="Sensores - Sistema IoT">
<Navigation />

<main class="px-4 py-6 pb-20">
    <!-- T√≠tulo -->
    <div class="text-center mb-6">
    <div class="text-5xl mb-3">üìä</div>
    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
        Sensores
    </h1>
    </div>

    <div class="max-w-lg mx-auto space-y-4">
    <!-- Estado del Dispositivo -->
    <div>
        <p class="text-xs text-gray-500 mb-2 font-medium">Estado del Dispositivo</p>
        <div id="connectionStatus" class="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
        <div class="flex items-center justify-center space-x-2">
            <span class="text-2xl">‚úì</span>
            <span class="text-green-700 text-base font-semibold">Conectado</span>
        </div>
        </div>
    </div>

    <!-- Modo, Fuente y Nivel de Agua (responsive) -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <!-- Modo de Operaci√≥n -->
        <div>
        <p class="text-xs text-gray-500 mb-2 font-medium text-center">Modo</p>
        <div id="modeBadge" class="bg-blue-50 border border-blue-200 rounded-xl p-3 text-center">
            <div class="flex flex-col items-center space-y-1">
            <span class="text-xl">ü§ñ</span>
            <span class="text-blue-700 text-sm font-semibold">Autom√°tico</span>
            </div>
        </div>
        </div>

        <!-- Fuente de Energ√≠a -->
        <div>
        <p class="text-xs text-gray-500 mb-2 font-medium text-center">Fuente</p>
        <div id="sourceBadge" class="bg-purple-50 border border-purple-200 rounded-xl p-3 text-center">
            <div class="flex flex-col items-center space-y-1">
            <span class="text-xl">‚ö°</span>
            <span class="text-purple-700 text-sm font-semibold">Externa</span>
            </div>
        </div>
        </div>

        <!-- Nivel de Agua (centrado abajo en m√≥vil) -->
        <div class="col-span-2 md:col-span-1 flex justify-center">
        <div class="w-full md:w-auto">
            <p class="text-xs text-gray-500 mb-2 font-medium text-center">Agua</p>
            <div id="waterLevel" class="bg-green-50 border border-green-200 rounded-xl p-3 max-w-[200px] md:max-w-none mx-auto">
            <div class="flex flex-col items-center space-y-1">
                <span class="text-2xl">üí¶</span>
                <span class="text-green-700 text-sm font-semibold">Hay Agua</span>
            </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Divisor -->
    <div class="border-t border-gray-200 pt-4">
        <p class="text-xs text-gray-500 mb-3 font-medium text-center">Datos de Sensores</p>
    </div>

    <!-- Cards de sensores -->
    <div class="space-y-3">
        <!-- Temperatura del Aire -->
        <div class="bg-white border-2 border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
            <div class="bg-red-100 p-2 rounded-lg">
                <span class="text-2xl">üå°Ô∏è</span>
            </div>
            <h3 class="font-semibold text-gray-800 text-sm">Temperatura del Aire</h3>
            </div>
            <div class="text-2xl font-bold text-gray-900" id="temp_aire">
            --¬∞C
            </div>
        </div>
        </div>

        <!-- Humedad del Aire -->
        <div class="bg-white border-2 border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
            <div class="bg-blue-100 p-2 rounded-lg">
                <span class="text-2xl">üíß</span>
            </div>
            <h3 class="font-semibold text-gray-800 text-sm">Humedad del Aire</h3>
            </div>
            <div class="text-2xl font-bold text-gray-900" id="hum_aire">
            --%
            </div>
        </div>
        </div>

        <!-- Humedad del Suelo -->
        <div class="bg-white border-2 border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
            <div class="bg-green-100 p-2 rounded-lg">
                <span class="text-2xl">üå±</span>
            </div>
            <h3 class="font-semibold text-gray-800 text-sm">Humedad del Suelo</h3>
            </div>
            <div class="text-2xl font-bold text-gray-900" id="hum_suelo">
            --%
            </div>
        </div>
        </div>

        <!-- Luminosidad -->
        <div class="bg-white border-2 border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
            <div class="bg-yellow-100 p-2 rounded-lg">
                <span class="text-2xl">üí°</span>
            </div>
            <h3 class="font-semibold text-gray-800 text-sm">Luminosidad</h3>
            </div>
            <div class="text-2xl font-bold text-gray-900" id="luz">
            -- lux
            </div>
        </div>
        </div>

        <!-- Temperatura del Suelo -->
        <div class="bg-white border-2 border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
            <div class="bg-orange-100 p-2 rounded-lg">
                <span class="text-2xl">üå°Ô∏è</span>
            </div>
            <h3 class="font-semibold text-gray-800 text-sm">Temperatura del Suelo</h3>
            </div>
            <div class="text-2xl font-bold text-gray-900" id="temp_suelo">
            --¬∞C
            </div>
        </div>
        </div>
    </div>

    <!-- Info -->
    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mt-6">
        <p class="text-xs text-gray-600 text-center">
        ‚ÑπÔ∏è Los datos se actualizan autom√°ticamente desde Firebase
        </p>
    </div>
    </div>
</main>
</Layout>

<script>
  // ========================================
  // üî• IMPORTAR FIREBASE
  // ========================================
  import { leerSensores, leerEstadoGeneral } from '../app/read.js';

  console.log('‚úÖ P√°gina de sensores cargada');

  // ========================================
  // üìä TIPOS DE DATOS
  // ========================================
  interface SensoresData {
    temp_aire: number;
    hum_aire: number;
    hum_suelo: number;
    nivel_agua: number;
    luz: number;
    temp_suelo: number;
  }

  interface EstadoGeneralData {
    marca_tiempo: number;
    modo_auto: boolean;
    estado: string;
    fecha_offline: string;
    fuente: string;
  }

  // ========================================
  // üìä LEER DATOS EN TIEMPO REAL
  // ========================================
  
  // Leer sensores
  leerSensores((datos: SensoresData | null) => {
    if (datos) {
      console.log('üå°Ô∏è Datos recibidos de sensores:', datos);
      updateSensors(datos);
      // Actualizar nivel de agua desde sensores
      if (datos.nivel_agua !== undefined) {
        updateWaterLevel(datos.nivel_agua);
      }
    }
  });

  // Leer estado general (modo, fuente, estado conexi√≥n)
  leerEstadoGeneral((datos: EstadoGeneralData | null) => {
    if (datos) {
      console.log('üì° Estado general recibido:', datos);
      updateConnectionStatus(datos.estado, datos.fecha_offline);
      updateMode(datos.modo_auto);
      updateSource(datos.fuente);
    }
  });

  // ========================================
  // üé® FUNCIONES PARA ACTUALIZAR UI
  // ========================================

  // Funci√≥n para actualizar estado de conexi√≥n
  function updateConnectionStatus(estado: string, fecha?: string): void {
    const statusDiv = document.getElementById('connectionStatus');
    if (!statusDiv) return;

    if (estado === "online") {
      statusDiv.className = 'bg-green-50 border border-green-200 rounded-xl p-4 text-center';
      statusDiv.innerHTML = `
        <div class="flex items-center justify-center space-x-2">
          <span class="text-2xl">‚úì</span>
          <span class="text-green-700 text-base font-semibold">Conectado</span>
        </div>
      `;
    } else {
      statusDiv.className = 'bg-red-50 border border-red-200 rounded-xl p-4 text-center';
      statusDiv.innerHTML = `
        <div class="flex items-center justify-center space-x-2">
          <span class="text-2xl">‚ö†Ô∏è</span>
          <span class="text-red-700 text-base font-semibold">Desconectado</span>
        </div>
        <p class="text-sm text-red-600 mt-2">
          √öltima conexi√≥n: <span>${fecha || '--'}</span>
        </p>
      `;
    }
  }

  // Funci√≥n para actualizar modo
  function updateMode(isAuto: boolean): void {
    const modeBadge = document.getElementById('modeBadge');
    if (!modeBadge) return;

    if (isAuto) {
      modeBadge.className = 'bg-blue-50 border border-blue-200 rounded-xl p-3 text-center';
      modeBadge.innerHTML = `
        <div class="flex flex-col items-center space-y-1">
          <span class="text-xl">ü§ñ</span>
          <span class="text-blue-700 text-sm font-semibold">Autom√°tico</span>
        </div>
      `;
    } else {
      modeBadge.className = 'bg-gray-50 border border-gray-200 rounded-xl p-3 text-center';
      modeBadge.innerHTML = `
        <div class="flex flex-col items-center space-y-1">
          <span class="text-xl">üë§</span>
          <span class="text-gray-700 text-sm font-semibold">Manual</span>
        </div>
      `;
    }
  }

  // Funci√≥n para actualizar fuente
  function updateSource(fuente: string): void {
    const sourceBadge = document.getElementById('sourceBadge');
    if (!sourceBadge) return;

    if (fuente === "externa") {
      sourceBadge.className = 'bg-purple-50 border border-purple-200 rounded-xl p-3 text-center';
      sourceBadge.innerHTML = `
        <div class="flex flex-col items-center space-y-1">
          <span class="text-xl">‚ö°</span>
          <span class="text-purple-700 text-sm font-semibold">Externa</span>
        </div>
      `;
    } else {
      sourceBadge.className = 'bg-orange-50 border border-orange-200 rounded-xl p-3 text-center';
      sourceBadge.innerHTML = `
        <div class="flex flex-col items-center space-y-1">
          <span class="text-xl">üîã</span>
          <span class="text-orange-700 text-sm font-semibold">Interna</span>
        </div>
      `;
    }
  }

  // Funci√≥n para actualizar nivel de agua (recibe n√∫mero 0-100)
  function updateWaterLevel(nivel: number): void {
    const waterLevel = document.getElementById('waterLevel');
    if (!waterLevel) return;

    // Considerar que hay agua si el nivel es mayor a 20%
    if (nivel > 0) {
      waterLevel.className = 'bg-green-50 border border-green-200 rounded-xl p-3 max-w-[200px] md:max-w-none mx-auto';
      waterLevel.innerHTML = `
        <div class="flex flex-col items-center space-y-1">
          <span class="text-2xl">üí¶</span>
          <span class="text-green-700 text-sm font-semibold">Hay Agua (${nivel}%)</span>
        </div>
      `;
    } else {
      waterLevel.className = 'bg-red-50 border border-red-200 rounded-xl p-3 max-w-[200px] md:max-w-none mx-auto';
      waterLevel.innerHTML = `
        <div class="flex flex-col items-center space-y-1">
          <span class="text-2xl">üíß</span>
          <span class="text-red-700 text-sm font-semibold">No Hay Agua (${nivel}%)</span>
        </div>
      `;
    }
  }

  // Funci√≥n para actualizar sensores
  function updateSensors(sensores: SensoresData): void {
    const tempAire = document.getElementById('temp_aire');
    const humAire = document.getElementById('hum_aire');
    const humSuelo = document.getElementById('hum_suelo');
    const luz = document.getElementById('luz');
    const tempSuelo = document.getElementById('temp_suelo');

    if (tempAire) tempAire.textContent = sensores.temp_aire !== undefined ? `${sensores.temp_aire}¬∞C` : "--¬∞C";
    if (humAire) humAire.textContent = sensores.hum_aire !== undefined ? `${sensores.hum_aire}%` : "--%";
    if (humSuelo) humSuelo.textContent = sensores.hum_suelo !== undefined ? `${sensores.hum_suelo}%` : "--%";
    if (luz) luz.textContent = sensores.luz !== undefined ? `${sensores.luz} lux` : "-- lux";
    if (tempSuelo) tempSuelo.textContent = sensores.temp_suelo !== undefined ? `${sensores.temp_suelo}¬∞C` : "--¬∞C";
  }
</script>